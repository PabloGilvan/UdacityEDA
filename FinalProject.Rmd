'---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(gridExtra)
library(readr)
library(stringr)
library(reshape2)
library(stringi)
library(lubridate)
# SE ESTIVER USANDO MAC, Setando Encoding
Sys.setlocale("LC_ALL", "pt_BR.UTF-8")
```

## Carregando dados
```{r}
infracoes  <- read.csv2(stringsAsFactors=FALSE, fileEncoding="ISO-8859-1", file = 'dez.csv', sep = ",")
```

```{r}
nrow(infracoes)
```


#### Carregando o conjunto de dados que lista o descritivo de cada infração do CBT
```{r}
tbl_infracao <- read.csv2(stringsAsFactors=FALSE, fileEncoding="ISO-8859-1", file = 'dominio/tbl_infracao.csv')
head(tbl_infracao)
```

#### Inicialmente vamos listar as 10 infrações que mais aparecem no conjunto de dados.
```{r}
infracoes_mais_comuns <- group_by(infracoes, cod_infracao)%>%
  summarise(registros=n()) %>%
  arrange(-registros) %>%
  head(n = 10)

infracoes_mais_comuns
```

Agora vamos associar os registros das Infrações Mais Comuns com o descritivo de cada infração

```{r}
infracoes_mais_comuns <- infracoes_mais_comuns %>%
  left_join(tbl_infracao, by = "cod_infracao") 

infracoes_mais_comuns
```

Podemos notar que um registro não estava no conjunto de dados de Infrações: 72422
Buscando no Código Brasileiro de Trânsito não consegui localizar via código de multa, acessando o site
do governo do Tocantins encontrei um documento que especifica o código como:

72422 - Em movimento de dia, deixar de manter acesa luz baixa nas rodovias.
Valor: $ 130.16 
Consultar CTB Municipal/Rodov 250, I, b
https://central3.to.gov.br/arquivo/320049/


```{r}
infracoes_mais_comuns$des_infracao[infracoes_mais_comuns$cod_infracao == 72422] <- "Em movimento de dia, deixar de manter acesa luz
baixa nas rodovias."

infracoes_mais_comuns$valor[infracoes_mais_comuns$cod_infracao == 72422] <- "130.16"

infracoes_mais_comuns$enquadramento[infracoes_mais_comuns$cod_infracao == 72422] <- "250 I, b"

infracoes_mais_comuns
```

Para podermos usar os dados de forma a categorizar os mesmos, precisamos primeiro converter os identificadores das infrações de
Inteiro para Factor.

```{r}
infracoes_mais_comuns$cod_infracao <- as.factor(infracoes_mais_comuns$cod_infracao)
infracoes$cod_infracao <- as.factor(infracoes$cod_infracao)
```


Ok, agora podemos plotar os registros e assim ter um comparativo mais visual dos dados.

```{r}
infracoes_mais_comuns %>%
  ggplot(mapping = aes(x = cod_infracao, y = registros))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=registros), vjust=0, color="red") +
    labs(title="Infrações com Maior Ocorrência no Período de 12/2018")+
    ylab("Quantidade")+
    xlab("Infração")+
    theme(plot.title = element_text(color="red", size=12, face="bold.italic"),
         axis.text.x = element_text(angle = 90, hjust = 1),
         axis.title=element_text(size=14,face="bold"))
```

Podemos notar que 3 tipos de infrações possuem muito mais ocorrência que as demais, com destaque para a infração de código 74550.
Gosto sempre de olhar os dados de forma proporcional. Vamos calcular a proporção de doação por tipo.

```{r}
num_registros <- nrow(infracoes)
infracoes_mais_comuns$proporcao <- round(infracoes_mais_comuns$registros/num_registros, digits = 2)
```

Agora podemos plotar como ficou a proporção de infrações por tipo de infração, assim temos uma ideia melhor.

```{r}
infracoes_mais_comuns %>%
  ggplot(mapping = aes(x = cod_infracao, y = proporcao))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=proporcao), vjust=0, color="red") +
    labs(title="Infrações com Maior Proporção no Período de 12/2018")+
    ylab("Proporção")+
    xlab("Infração")+
    theme(plot.title = element_text(color="red", size=12, face="bold.italic"),
         axis.text.x = element_text(angle = 90, hjust = 1),
         axis.title=element_text(size=14,face="bold"))
```

Com essas 3 infrações temos cerca de 70% de ocorrência. Vamos listar quais são.

```{r}
top_3 <- infracoes_mais_comuns %>%
    subset(cod_infracao == 72422 | cod_infracao == 74550 | cod_infracao == 74630)
top_3$des_infracao
```

Bacana, agora uma coisa que me deixa curioso é saber o quanto nosso governo está ganhando com isso, visto que somente com esse projeto de lei mais recente(72422) já estar configurando quase 10% das infrações. Vamos calcular o valor que cada grupo de infrações
rendeu(ou renderá) aos cofres públicos.

Primeiramente temos que converter os valores da coluna 'valor' de character para double, depois vamos multiplicar o valor
pela quantidade de ocorrências de cada infração.

```{r}
infracoes_mais_comuns$valor <- as.double(infracoes_mais_comuns$valor)
infracoes_mais_comuns$arrecadacao <- round(infracoes_mais_comuns$valor * infracoes_mais_comuns$registros, digits = 2)
total <- sum(infracoes_mais_comuns$arrecadacao)
paste("R$",format(total, big.mark=".", decimal.mark = ","),sep="")
```

    
### Período do Mês com Mais Infrações

Antes de agrupar por data, vamos converter o valor da coluna 'dat_infracao' para o tipo 'factor', hoje a coluna está com valor
'character'.
```{r}

infracoes$dat_infracao <- as.factor(infracoes$dat_infracao)

periodo_maior_ocorrencia <- group_by(infracoes, dat_infracao)%>%
  summarise(registros=n()) %>%
  arrange(-registros) %>%
  head(n = 10)

periodo_maior_ocorrencia
```

```{r}
periodo_maior_ocorrencia %>%
  ggplot(mapping = aes(x = dat_infracao, y = registros))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=registros), vjust=0, color="blue") +
    labs(title="Dias com maior Registros de Infrações: Dez/2018")+
    ylab("Quantidade")+
    xlab("Data")+
    theme(plot.title = element_text(color="red", size=12, face="bold.italic"),
         axis.text.x = element_text(angle = 90, hjust = 1),
         axis.title=element_text(size=14,face="bold"))
```


### Trecho com maior número de infrações
Para selecionar os trechos com maior ocorrência de infrações tive também que agrupar por UF, pois visto que temos várias
rodovias federais e um mesmo valor(ex: 2) de trecho pode corresponder a um entre vários com mesmo valor.

```{r}
trecho_maior_ocorrencia <- group_by(infracoes, num_km_infracao, uf_infracao)%>%
  summarise(registros=n()) %>%
  arrange(-registros) %>%
  head(n = 10)

trecho_maior_ocorrencia
```

Para plotar o próximo gráfico, vamos ter que modificar um pouco o formato do conjunto de dados. Vamos ter que primeiramente agrupar
a coluna 'num_km_infracao' com a coluna 'uf_infracao', assim tornando fácil plotar o gráfico, de forma que consigamos distinguir os kilômetros de mesmo valor, mas com UF diferente.

```{r}
trecho_maior_ocorrencia %>%
  ggplot(mapping = aes(x = dat_infracao, y = registros))+
    geom_bar(stat = "identity")+
    geom_text(aes(label=registros), vjust=0, color="blue") +
    labs(title="Dias com maior Registros de Infrações: Dez/2018")+
    ylab("Quantidade")+
    xlab("Data")
```

```{r}
acidentes  <- read.csv2(stringsAsFactors=FALSE, fileEncoding="ISO-8859-1", file = 'datatran2018.csv', sep = ";")
```


### Período do Mês com Maior Número de Acidentes

```{r}

acidentes$data_inversa <- as.factor(acidentes$data_inversa)

periodo_mais_acidentes <- group_by(acidentes, data_inversa)%>%
  summarise(registros=n()) %>%
  arrange(-registros) %>%
  head(n = 10)

periodo_mais_acidentes
```


### Trecho com maior número de acidentes

```{r}
trecho_mais_acidentes <- group_by(acidentes, km, uf)%>%
  summarise(registros=n()) %>%
  arrange(-registros) %>%
  head(n = 10)

trecho_mais_acidentes
```


#### Trechos com menor quantidade de infrações registradas

```{r}
trecho_menor_ocorrencia <- group_by(infracoes, num_km_infracao, uf_infracao)%>%
  summarise(registros=n()) %>%
  arrange(registros) %>%
  head(n = 10)

trecho_menor_ocorrencia
```















